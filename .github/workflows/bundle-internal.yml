name: å…§éƒ¨è³‡æºæ›´æ–°

run-name: ğŸš€ [${{ inputs.environment }}] ç‰ˆæœ¬:${{ inputs.version_name }} ç”± @${{ github.actor }} è§¸ç™¼

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç’°å¢ƒ'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - test
          - production
      version_name:
        description: 'ç‰ˆæœ¬åç¨±'
        required: true
        default: '1.2.12'
        type: choice
        options:
          - 1.2.12
          - 1.66.1
          - 1.66.2
          - 1.66.3
          - 1.66.4
          - 1.66.5
          - 1.66.6
          - 1.66.7
      build_windows:
        description: 'æ‰“åŒ…Windowsç’°å¢ƒ'
        required: true
        default: true
        type: boolean
      build_android:
        description: 'æ‰“åŒ…Androidç’°å¢ƒ'
        required: true
        default: true
        type: boolean
      build_ios:
        description: 'æ‰“åŒ…iOSç’°å¢ƒ'
        required: true
        default: true
        type: boolean

# é˜²æ­¢å¤šå€‹æ‰“åŒ…ä»»å‹™åŒæ™‚åœ¨åŒä¸€å€‹ Runner ä¸Šæ‰“æ¶
concurrency:
  group: cocos-bundle-update-${{ github.ref }}
  cancel-in-progress: false

jobs:
  summary_inputs:
    runs-on: [self-hosted] # å¿…é ˆæŒ‡å®š runner
    steps:
      - name: Checkout for Summary Action
        uses: actions/checkout@v4 # å¿…é ˆå…ˆ checkout æ‰èƒ½ä½¿ç”¨æœ¬åœ°çš„ summary-inputs action
      
      - name: Summary Inputs
        uses: ./.github/actions/summary-inputs
        with:
          all_inputs: ${{ toJSON(inputs) }}

  build_windows:
    if: ${{ inputs.build_windows }}
    needs: summary_inputs # ç­‰ summary è·‘å®Œå†é–‹å§‹
    runs-on: [self-hosted]
    steps:
      - name: check out
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
          clean: false

      - name: Build Bundle(Windows)
        uses: ./.github/actions/update-bundles
        with:
          git_token: ${{ github.token }} 
          force_clean: false
          environment: ${{ inputs.environment }}
          platform: windows
          dev_mode: true
          auto_compile: false
          version_name: ${{ inputs.version_name }}

  build_ios:
    needs: build_windows # å»ºè­°ä¸²è¯åŸ·è¡Œï¼Œé¿å… self-hosted åŒæ™‚è·‘å¤šå€‹æ‰“åŒ…ä»»å‹™å°è‡´ CPU ç‚¸è£‚
    if: always() && inputs.build_ios # å³ä½¿å‰ä¸€å€‹ windows æ²’è·‘æˆ–å¤±æ•—ï¼Œåªè¦å‹¾é¸ ios ä¹Ÿè¦è·‘
    runs-on: [self-hosted]
    steps:
      - name: check out
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
          clean: false

      - name: Build Bundle(iOS)
        uses: ./.github/actions/update-bundles
        with:
          git_token: ${{ github.token }} 
          force_clean: false
          environment: ${{ inputs.environment }}
          platform: ios
          dev_mode: true
          auto_compile: false
          version_name: ${{ inputs.version_name }}

  build_android:
    needs: [summary_inputs, build_ios] # ç¢ºä¿æœ€å¾Œè·‘
    if: always() && inputs.build_android
    runs-on: [self-hosted]
    steps:
      - name: check out
        uses: actions/checkout@v4
        with:
          submodules: recursive
          lfs: true
          clean: false

      - name: Build Bundle(Android)
        uses: ./.github/actions/update-bundles
        with:
          git_token: ${{ github.token }} 
          force_clean: false
          environment: ${{ inputs.environment }}
          platform: android
          dev_mode: true
          auto_compile: false
          version_name: ${{ inputs.version_name }}