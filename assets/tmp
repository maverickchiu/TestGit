import { _decorator, assert, Component, math, Node, UITransform, Widget } from 'cc';
const { ccclass, property } = _decorator;

export interface ISymbolProvider {
    getSymbolNode(index: number, type: number, node: Node): Node;
}

@ccclass('ReelSpinner')
export class ReelSpinner extends Component {
    @property(Widget)
    private content: Widget = null;
    @property
    private spacing: number = 0;

    declare private index: number;
    declare private provider: ISymbolProvider;

    protected onLoad(): void {
        this.content.isAlignTop = false;
        this.content.isAlignBottom = true;
    }

    init(provider: ISymbolProvider) {
        this.provider = provider;
        this.index = 0;
        this.initSymbol();
    }

    private initSymbol() {
        this.fillUpperSymbols(this.content);
    }

    move(offset: number) {
        assert(this.provider !== undefined, 'provider is not set');
        
        const content = this.content;
        content.bottom += offset;
        const node = content.node;
        if(offset > 0) {
            // 向上
            if(content.bottom >= 0) {
                const firstChild = node.children[0];
                firstChild.parent = null;
                firstChild.destroy();

                const fillHeight = this.fillLowerSymbols(content);
                content.bottom -= fillHeight;
            }
        } else {
            // 向下
            const lastChild = node.children[node.children.length - 1];
            const trans = lastChild.getComponent(UITransform);
            if(content.bottom <= -(trans.height + this.spacing)) {
                content.bottom += trans.height + this.spacing;

                // 销毁最上面的Symbol 之後使用pool
                lastChild.parent = null;
                lastChild.destroy();

                this.fillUpperSymbols(content);
            }
        }
    }

    private getSymbol(){
        const node = this.provider.getSymbolNode(this.index, 0, undefined);
        return node;
    }

    private fillLowerSymbols(content: Widget){
        const contentTrans = content.getComponent(UITransform);
        const viewTrans = this.getComponent(UITransform);
        const height = Math.max(contentTrans.height, viewTrans.height);

        const contentNode = content.node;
        let curHeight = 0;
        for (const child of contentNode.children) {
            curHeight += child.getComponent(UITransform).height;
        }
        curHeight += this.spacing * (contentNode.children.length - 1);

        let fillHeight = 0;
        while(curHeight <= height){
            // 生成新的Symbol放在最下面
            const symbol = this.getSymbol();
            this.index--;
            symbol.parent = contentNode;
            symbol.setSiblingIndex(contentNode.children.length - 1);
            const trans = symbol.getComponent(UITransform);
            curHeight += trans.height + this.spacing;
            fillHeight += trans.height + this.spacing;
        }

        return fillHeight;
    }

    private fillUpperSymbols(content: Widget){
        const contentTrans = content.getComponent(UITransform);
        const viewTrans = this.getComponent(UITransform);
        const height = Math.max(contentTrans.height, viewTrans.height);

        const contentNode = content.node;
        let curHeight = 0;
        for (const child of contentNode.children) {
            curHeight += child.getComponent(UITransform).height;
        }
        curHeight += this.spacing * (contentNode.children.length - 1);

        while(curHeight <= height){
            // 生成新的Symbol放在最上面
            const symbol = this.getSymbol();
            this.index++;
            symbol.parent = content.node;
            symbol.setSiblingIndex(0);
            curHeight += symbol.getComponent(UITransform).height + this.spacing;
        }
    }
}