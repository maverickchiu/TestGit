import { _decorator, assert, Component, Layout, math, Node, UITransform, Widget } from 'cc';
const { ccclass, property } = _decorator;

export interface ISymbolProvider {
    getSymbolNode(index: number, type: number, node: Node): Node;
}

interface IViewItem {
    index: number;
    trans: UITransform;
    node: Node;
}

@ccclass('ReelSpinner')
export class ReelSpinner extends Component {
    @property(Widget)
    private content: Widget = null;
    @property
    private spacing: number = 0;

    declare private viewItems: IViewItem[];
    declare private provider: ISymbolProvider;

    protected onLoad(): void {
        this.content.isAlignTop = false;
        this.content.isAlignBottom = true;
        this.viewItems = [];
    }

    init(provider: ISymbolProvider) {
        this.provider = provider;
        this.initSymbol();
        this.content.bottom = 0;
    }

    private initSymbol() {
        this.fillUpperSymbols(this.content);
    }

    move(offset: number) {
        assert(this.provider !== undefined, 'provider is not set');
        
        const content = this.content;
        content.bottom += offset;
        const node = content.node;
        if(offset > 0) {
            // 向上
            if(content.bottom >= 0) {
                const firstItem = this.viewItems[0];
                const firstNode = firstItem.node;
                firstNode.parent = null;
                firstNode.destroy();
                this.viewItems.shift();

                const fillHeight = this.fillLowerSymbols(content);
                this.content.getComponent(Layout).updateLayout();
                content.bottom -= fillHeight;
            }
        } else {
            // 向下
            const viewItems = this.viewItems;
            const lastItem = viewItems[viewItems.length - 1];
            const trans = lastItem.trans;
            if(content.bottom <= -(trans.height + this.spacing)) {
                // 销毁最上面的Symbol 之後使用pool
                lastItem.node.parent = null;
                lastItem.node.destroy();
                viewItems.pop();

                this.fillUpperSymbols(content);
                
                this.content.getComponent(Layout).updateLayout();
                content.bottom += trans.height + this.spacing;
            }
        }
    }

    private getSymbol(index: number){
        const node = this.provider.getSymbolNode(index, 0, undefined);
        return node;
    }

    private fillLowerSymbols(content: Widget){
        const viewTrans = this.getComponent(UITransform);
        const height = viewTrans.height * 2;

        const contentNode = content.node;
        const viewItems = this.viewItems;
        let curHeight = 0;
        for (const item of viewItems) {
            curHeight += item.trans.height;
        }
        curHeight += Math.max(0,this.spacing * (viewItems.length - 1));

        let fillHeight = 0;
        while(curHeight <= height){
            // 生成新的Symbol放在最下面
            const nowMinIndex = viewItems[viewItems.length - 1]?.index ?? 0;
            const newIndex = nowMinIndex - 1;
            const symbol = this.getSymbol(newIndex);
            const newItem = {
                index: newIndex,
                trans: symbol.getComponent(UITransform),
                node: symbol,
            };
            viewItems.push(newItem);

            symbol.parent = contentNode;
            symbol.setSiblingIndex(viewItems.length - 1);
            curHeight += newItem.trans.height + this.spacing;
            fillHeight += newItem.trans.height + this.spacing;
        }

        return fillHeight;
    }

    private fillUpperSymbols(content: Widget){
        const viewTrans = this.getComponent(UITransform);
        const height = viewTrans.height * 2;

        const viewItems = this.viewItems;
        let curHeight = 0;
        for (const item of viewItems) {
            curHeight += item.trans.height;
        }
        curHeight += Math.max(0,this.spacing * (viewItems.length - 1));

        while(curHeight <= height){
            // 生成新的Symbol放在最上面
            const nowMaxIndex = viewItems[0]?.index ?? 0;
            const newIndex = nowMaxIndex + 1;
            const symbol = this.getSymbol(newIndex);
            const newItem = {
                index: newIndex,
                trans: symbol.getComponent(UITransform),
                node: symbol,
            };
            viewItems.unshift(newItem);
            symbol.parent = content.node;
            symbol.setSiblingIndex(0);
            curHeight += newItem.trans.height + this.spacing;
        }
    }
}